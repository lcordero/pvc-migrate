apiVersion: v1
kind: Pod
metadata:
  name: "{{ pod_name }}"
  namespace: "{{ pvc_namespace }}"
  labels:
    app: "{{ pod_name }}"
    purpose: rsync
    owner: pvc-migrate
spec:
  volumes:
{% for pvc in pvcs %}
  - name: "{{ pvc.pvc_vol_safe_name }}"
    persistentVolumeClaim:
      claimName: "{{ pvc.pvc_name }}"
{% endfor %}
  containers:
  - name: rsyncd
    resources:
      limits:
        cpu: "{{ transfer_pod_cpu_limits }}"
        memory: "{{ transfer_pod_mem_limits }}"
      requests:
        cpu: "{{ transfer_pod_cpu_requests }}"
        memory: "{{ transfer_pod_mem_requests }}"
    imagePullPolicy: Always
    command:
      - /bin/bash
      - -c
      - sleep infinity
      # - "echo {{ mig_dest_ssh_user }}:$(echo $rsyncd_pass | base64 -d) > /etc/rsyncd.secrets && chmod 0600 /etc/rsyncd.secrets && /usr/bin/rsync --daemon --no-detach --port {{ rsyncd_port }} -vvv"
    image: "{{ transfer_pod_image }}"
    volumeMounts:
{% for pvc in pvcs %}
    - mountPath: "/mnt/{{ pvc_namespace }}/{{ pvc.pvc_vol_safe_name }}"
      name: "{{ pvc.pvc_vol_safe_name }}"
{% endfor %}
    securityContext:
      privileged: true
      readOnlyRootFilesystem: false
      runAsUser: 0
